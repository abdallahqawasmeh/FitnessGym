@model IEnumerable<Subscription>

@{
    ViewData["Title"] = "Subscriptions";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}


<link href="https://cdn.datatables.net/1.11.1/css/jquery.dataTables.min.css" rel="stylesheet" />
<link href="https://cdn.datatables.net/buttons/2.0.0/css/buttons.dataTables.min.css" rel="stylesheet" />



<div class="container mt-5">
    <h2 class="text-center mb-4">Subscriptions Report</h2>

    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger">@TempData["Error"]</div>
    }

    <form asp-action="Report" method="post" class="mb-4">
        <div class="row">
            <div class="col-md-4">
                <input type="date" name="startDate" class="form-control" placeholder="Start Date" />
            </div>
            <div class="col-md-4">
                <input type="date" name="endDate" class="form-control" placeholder="End Date" />
            </div>
            <div class="col-md-4">
                <button class="btn btn-primary w-100">Search</button>
            </div>
        </div>
    </form>

    <div class="text-center mb-3">
        @if (ViewBag.StartDate != null && ViewBag.EndDate != null)
        {
            <p>Showing results from <strong>@ViewBag.StartDate</strong> to <strong>@ViewBag.EndDate</strong></p>
        }
        else
        {
            <p>Showing all subscriptions</p>
        }
    </div>

    <table class="table table-bordered">
        <thead class="table-light">
            <tr>
                <th>Member Name</th>
                <th>Plan Name</th>
                <th>Price</th>
                <th>Start Date</th>
                <th>End Date</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Model)
            {
                <tr>
                    <td>@item.Member.Firstname @item.Member.Lastname</td>
                    <td>@item.Plan.Planname</td>
                    <td>@item.Plan.Price.ToString("0.00") JOD</td>
                    <td>@item.Startdate.ToShortDateString()</td>
                    <td>@item.Enddate.ToShortDateString()</td>
                </tr>
            }
        </tbody>
        <tfoot>
            <tr>
                <td colspan="2" class="fw-bold">Total Prices</td>
                <td colspan="3">@ViewBag.TotalPrice.ToString("0.00") JOD</td>
            </tr>
       
        </tfoot>
    </table>
</div>

<!-- Charts Row -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card bg-secondary text-white">
            <div class="card-body">
                <h5 class="card-title">Revenue by Date</h5>
                <canvas id="revenueByDateChart" height="150"></canvas>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card bg-secondary text-white">
            <div class="card-body">
                <h5 class="card-title">Subscriptions by Plan</h5>
                <canvas id="subsByPlanChart" height="150"></canvas>
            </div>
        </div>
    </div>
</div>







<script src="https://code.jquery.com/jquery-3.5.1.js"></script>
<script src="https://cdn.datatables.net/1.11.1/js/jquery.dataTables.min.js" defer></script>

<script src="https://cdn.datatables.net/buttons/2.0.0/js/dataTables.buttons.min.js" defer></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>


<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
<script src="https://cdn.datatables.net/buttons/2.0.0/js/buttons.html5.min.js" defer></script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    $(document).ready(function () {
        $('#example').DataTable({
            dom: 'Bfrtip',
            buttons: [
                'copyHtml5',
                'excelHtml5',
                'csvHtml5',
                'pdfHtml5'
            ]
        });
    });
</script>
<script>
    $(document).ready(function () {
        // Your existing DataTables init can stay here
        // (if you fix the id you can use it, otherwise ignore)

        // ===== Chart.js data from server =====
        var revenueByDateData = @Html.Raw(ViewBag.RevenueByDate ?? "[]");
        var subsByPlanData = @Html.Raw(ViewBag.SubsByPlan ?? "[]");

        // ===== Revenue by Date (Line Chart) =====
        if (revenueByDateData.length > 0 && document.getElementById('revenueByDateChart')) {
            var ctx1 = document.getElementById('revenueByDateChart').getContext('2d');

            new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: revenueByDateData.map(x => x.date),
                    datasets: [{
                        label: 'Revenue (JOD)',
                        data: revenueByDateData.map(x => x.total),
                        borderWidth: 2,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            labels: { color: '#ffffff' }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#dddddd' }
                        },
                        y: {
                            ticks: { color: '#dddddd' }
                        }
                    }
                }
            });
        }

        // ===== Subscriptions by Plan (Bar Chart) =====
        if (subsByPlanData.length > 0 && document.getElementById('subsByPlanChart')) {
            var ctx2 = document.getElementById('subsByPlanChart').getContext('2d');

            new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: subsByPlanData.map(x => x.plan),
                    datasets: [{
                        label: 'Subscriptions',
                        data: subsByPlanData.map(x => x.count),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            labels: { color: '#ffffff' }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#dddddd' }
                        },
                        y: {
                            ticks: { color: '#dddddd' }
                        }
                    }
                }
            });
        }
    });
</script>


